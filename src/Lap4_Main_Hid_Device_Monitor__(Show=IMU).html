<!DOCTYPE html>
<!-- WebHID Device Monitor - Handles 63-byte reports and displays byte 42 value -->
<!-- Modified by AI Assistant to accommodate 63-byte payloads -->
<!-- last change 2026_02_24  -->
<html>
<head>
    <title>HID Device Monitor (for Lap4 Main+IMU)</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 20px auto; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        /* New pink button style */
        button.button_pink {
            background-color: #ff69b4; /* Hot pink */
            color: white;
            border: none;
            border-radius: 8px; /* Rounded corners */
            box-shadow: 0 4px 6px rgba(255, 105, 180, 0.4);
            transition: background-color 0.3s ease;
        }
        button.button_pink:hover:not(:disabled) {
            background-color: #ff4da6;
        }
        button.button_pink:disabled {
            background-color: #ffc3db;
            cursor: not-allowed;
            box-shadow: none;
        }
        #status, #debug, { color: #666; margin-top: 10px; }
        #message { color: #c896b4; margin-top: 10px;font-size: 14px; }
        #version { color: #aaaaaa; font-size: 16px; margin-top: 20px; }
        /* Other outputs */
        #output3, #output4, #output5{
/*            font-size: 20px; margin-top: 10px; padding: 10px; border: 1px solid #ccc; */
          display: inline-block; width: 171px; height: 20px; padding: 10px; border: 1px solid #ccc;
          vertical-align: middle; margin-right: 1px; margin-top: 10px; font-size: 18px;
        }
        #output6 {
            font-size: 24px; margin-top: 10px; padding: 10px; border: 1px solid #ccc;
        }
        #output7 {
            font-size: 24px; margin-top: 10px; padding: 10px; border: 1px solid #ccc;
        }
        #output8 {
            font-size: 24px; margin-top: 10px; padding: 10px; border: 1px solid #ccc;
        }
        #output9 {
            font-size: 20px; margin-top: 10px; padding: 10px; border: 1px solid #ccc;
        }
        #output10 {
            font-size: 20px; margin-top: 10px; padding: 10px; border: 1px solid #ccc;
        }
        /* NEW: Responsive image */
        .responsive-img {
            width: 100%;    /* Image takes full width of its parent container */
            height: auto;   /* Height automatically scales proportionally to maintain aspect ratio*/
            display: block; /* Makes image behave like a block element so width: 100% works properly*/
            margin: 10px 0; /* Adds 10px top/bottom spacing between image and surrounding elements */
        }
    </style>
</head>
<body>
    <h1>HID Device Monitor (Lap4 Main+IMU)</h1>
        <button id="connectBtn" onclick="connectDevice()" accesskey="c">Connect to HID Device</button>
        <!-- Add this button AFTER the existing connect button -->
        <button id="startStreamingBtn" onclick="sendStartStreaming()" disabled>Start Streaming</button>
        <button id="sendTBD_Btn" onclick="sendTBD()" disabled>send TBD</button>
        <button id="GetVersionBtn" onclick="sendGetVersion()" disabled>Stop Streaming</button>
        <!-- New pink button added -->
        <!-- <button id="pinkBtn" class="button_pink" onclick="sendResetMCU()" disabled>Reset MCU</button> -->
        <div id="status">Status: Not connected</div>
        <div id="message"><b>FW ver:</b> Press F12 (Developer Tools) -> [console] + Press "Stop Streaming" button!</div>
        <div id="output3">Yaw Value: -</div>
        <div id="output4">Pitch Value: -</div>
        <div id="output5">Roll Value: -</div>
        <div id="output6">Digital Inputs BitArray: -</div>
        <canvas id="imgCanvas" class="responsive-img"></canvas>
        <div id="output7">Digital Outputs_1 BitArray: -</div>
        <div id="message"><b>Output Set:</b> Ind_9 Ind_8 Ind_7 Ind_6 Ind_5 Ind_4 Ind_3 Ind_2 Ind_1 </div>
        <button id="sendInd_9" onclick="sendInd_x(9,1)" disabled>_9</button>
        <button id="sendInd_8" onclick="sendInd_x(8,1)" disabled>_8</button>
        <button id="sendInd_7" onclick="sendInd_x(7,1)" disabled>_7</button>
        <button id="sendInd_6" onclick="sendInd_x(6,1)" disabled>_6</button>
        <button id="sendInd_5" onclick="sendInd_x(5,1)" disabled>_5</button>
        <button id="sendInd_4" onclick="sendInd_x(4,1)" disabled>_4</button>
        <button id="sendInd_3" onclick="sendInd_x(3,1)" disabled>_3</button>
        <button id="sendInd_2" onclick="sendInd_x(2,1)" disabled>_2</button>
        <button id="sendInd_1" onclick="sendInd_x(1,1)" disabled>_1</button>
        <div id="message"><b>Output ReSet:</b> Ind_9 Ind_8 Ind_7 Ind_6 Ind_5 Ind_4 Ind_3 Ind_2 Ind_1 </div>
        <button id="sendInd_9_off" onclick="sendInd_x(9,0)" disabled>_9</button>
        <button id="sendInd_8_off" onclick="sendInd_x(8,0)" disabled>_8</button>
        <button id="sendInd_7_off" onclick="sendInd_x(7,0)" disabled>_7</button>
        <button id="sendInd_6_off" onclick="sendInd_x(6,0)" disabled>_6</button>
        <button id="sendInd_5_off" onclick="sendInd_x(5,0)" disabled>_5</button>
        <button id="sendInd_4_off" onclick="sendInd_x(4,0)" disabled>_4</button>
        <button id="sendInd_3_off" onclick="sendInd_x(3,0)" disabled>_3</button>
        <button id="sendInd_2_off" onclick="sendInd_x(2,0)" disabled>_2</button>
        <button id="sendInd_1_off" onclick="sendInd_x(1,0)" disabled>_1</button>

        <div id="output8">Digital Outputs_2 BitArray: -</div>
        <div id="output9">Analog Value: -</div>
        <div id="output10">calib_status: -</div>
        <button id="ResetBNO055UBtn" onclick="sendResetBNO055()" disabled>Reset BNO055</button>
        <button id="ResetMCUBtn" onclick="sendResetMCU()" disabled>Reset MCU</button>
        <button id="BslDFUBtn" class="button_pink" onclick="sendBslDFU()" disabled>MCU—►BSL=DFU</button>
        <button id="SaveCalibBtn" onclick="SaveCalibToFlash()" disabled>SaveCalibrationToFlash</button>
        <!-- <button id="pinkBtn" class="button_pink" onclick="sendResetMCU()" disabled>Reset MCU</button> -->
        <div id="debug"></div>
        <div id="version">Lap4_Main Monitor version: (2026_02_24__18_24)<br><b><u>Changes:</u></b><br>• ResetMCUBtn was added<br>
        • 18 Ind_x button<br>• DFU button<br>• Inputs + Outputs_1/2 BitArray was added<br></div>
        <!-- <button id="GetResetBtn" onclick="sendGetVersion()" disabled>Reset MCU</button> -->
        <div id="imgContainer"></div>

    <script>
        let device = null;

// Add this line inside connectDevice() after successful connection:
// (After device.addEventListener('inputreport', handleInputReport);)
// document.getElementById('startStreamingBtn').disabled = false;

        const temp_img = document.getElementById("imgContainer").innerHTML =
            '<img src="img/Patient_Position_Indicators_Indices.webp" alt="Patient position">';

        const canvas = document.getElementById('imgCanvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        let imageLoaded = false;
        img.src = 'img/Patient_Position_Indicators_Indices.webp';
        let mouseX = 0;
        let mouseY = 0;
        // original image width: 717 , app-width: 600px therefore:
        const imgSrinkFactor = 600/717; 
        const color_light_green = '#90EE90';  // light green
        
        // the indications leds position:
        const P = [
          {x: 296.5, y: 392.125},
          {x: 224.5, y: 427.125},
          {x: 374.5, y: 417.125},
          {x: 117.5, y: 321.125},
          {x: 292.5, y: 309.125},
          {x: 468.5, y: 295.125},
          {x: 148.5, y: 176.125},
          {x: 410.5, y: 155.125},
          {x: 274.5, y: 104.125}
        ];

        img.onload = function() {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            imageLoaded = true;
        };
        let prevDigitalHi = 0; 
        let prevDigitalLo = 0; 
        
        // Now Ctrl+I anywhere in your app logs the current mouse coordinates to console, even if mouse isn't
        // hovering the canvas. Works globally on your page.
        document.addEventListener('keydown', function(e) {
             const isCtrl = e.ctrlKey || e.metaKey;
             
            if (e.ctrlKey && e.key === 'i') {
                e.preventDefault();  // Prevent browser devtools (Ctrl+i)
                // const color = '#90EE90';  // light green
                drawCircleXY(mouseX, mouseY, '#90EE90');
                // drawCircleXY(mouseX, mouseY, color);
                console.log(`mouseX ${mouseX} mouseY ${mouseY}`);
            }
            
              if (isCtrl && e.key === 'd') {
                e.preventDefault();
                redrawImageOnly();  // Clear circle, show clean image
              }

              // Use Ctrl+Shift+P instead for  turn on the light on Current mouse position
              if (isCtrl && e.shiftKey && e.key === 'p') {                
                e.preventDefault();
                const color = '#90EE90';  // light green
                //drawCircleXY(mouseX, mouseY, '#90EE90');
                drawCircleXY(mouseX, mouseY, color);
                console.log(`ctrl+p : mouseX ${mouseX} mouseY ${mouseY}`);
              }

              if (isCtrl && e.key === '5') {
                e.preventDefault();
                // const color = '#90EE90';  // light green
                // drawCircleXY(148, 175, color);  
                drawCircleXY(P[5].x, P[5].y, 'blue');
              }

              if (isCtrl && e.key === '4') {
                e.preventDefault();
                setLedIndication( 4 );
                // drawCircleXY(P[4].x, P[4].y, 'blue');
              }


              if (isCtrl && e.shiftKey && e.key === 'E') {
                e.preventDefault();
                const color = '#EE9090' ; // light red
                drawCircleXY(148, 175, color);  
              }

        });
        

        // Mouse move - track position relative to canvas
        canvas.addEventListener('mousemove', function(e) {
            const rect = canvas.getBoundingClientRect();
            mouseX = e.clientX - rect.left;
            mouseY = e.clientY - rect.top;
            // drawMouseCircle();  // Redraw with new position
        });

        // Mouse leave - hide circle
        canvas.addEventListener('mouseleave', function() {
            // redrawImageOnly();  // Clear circle, show clean image
        });
        
        function setLedIndication( index )
        {
          drawCircleXY(P[index].x, P[index].y, color_light_green );
        }
        
        function drawCircleXY(x, y, color) {
            if (!imageLoaded) {
                console.log('Image not loaded yet');
                return;
            }
            
            // Redraw image first (clears previous drawings)
            // ctx.clearRect(0, 0, canvas.width, canvas.height);
            // ctx.drawImage(img, 0, 0);
            
            const radius = 21;  // diameter 28px / 2
            
            ctx.beginPath();
            ctx.arc(x * 1/imgSrinkFactor, y * 1/imgSrinkFactor, radius, 0, 2 * Math.PI);
            ctx.strokeStyle = color; // '#EE9090';  // light red
            ctx.lineWidth = 5;
            ctx.stroke();
        }

        // NEW: Function to draw circle - call this when needed
        function drawCircle() {
            if (!imageLoaded) {
                console.log('Image not loaded yet');
                return;
            }
            
            // Redraw image first (clears previous drawings)
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
            
            // Draw light green circle in center
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 15;  // diameter 28px / 2
            
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            ctx.strokeStyle = '#90EE90';  // light green
            ctx.lineWidth = 5;
            ctx.stroke();
        }

        // NEW: Draw circle at mouse position (only when hovering)
        function drawMouseCircle() {
            if (!imageLoaded) return;
            
            const radius = 21;  // diameter = 2x radius

            // Redraw clean image first
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
            
            // Draw circle at mouse position
            ctx.beginPath();
            let scaledMousX = 0;
            let scaledMousY = 0;
            scaledMousX = mouseX* 1/imgSrinkFactor; // 717/600;
            scaledMousY = mouseY* 1/imgSrinkFactor; // 717/600;
            ctx.arc(scaledMousX, scaledMousY, radius, 0, 2 * Math.PI);  // radius 14px (diameter 28px)
            ctx.strokeStyle = '#90EE90';
            ctx.lineWidth = 5;
            ctx.stroke();
        }

        // NEW: Show image without circle
        function redrawImageOnly() {
            if (!imageLoaded) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
        }

        async function connectDevice() {
            try {
                [device] = await navigator.hid.requestDevice({ filters: [] });
                if (!device) {
                    updateStatus('No device selected');
                    return;
                }
                await device.open();
            } catch (error) {
                updateStatus(`Error: ${error.message}`);
                return;
            }
            updateStatus(`Connected: ${device.productName}`);
            device.addEventListener('inputreport', handleInputReport);
            document.getElementById('startStreamingBtn').disabled = false;
            // document.getElementById('sendTBD_Btn').disabled = false;
            document.getElementById('GetVersionBtn').disabled = false;
            document.getElementById('ResetMCUBtn').disabled = false;
            document.getElementById('SaveCalibBtn').disabled = false;
            document.getElementById('ResetBNO055UBtn').disabled = false;
            document.getElementById('BslDFUBtn').disabled = false;
            // document.getElementById('pinkBtn').disabled = false;

            document.getElementById('sendInd_9').disabled = false;
            document.getElementById('sendInd_8').disabled = false;
            document.getElementById('sendInd_7').disabled = false;
            document.getElementById('sendInd_6').disabled = false;
            document.getElementById('sendInd_5').disabled = false;
            document.getElementById('sendInd_4').disabled = false;
            document.getElementById('sendInd_3').disabled = false;
            document.getElementById('sendInd_2').disabled = false;
            document.getElementById('sendInd_1').disabled = false;

            document.getElementById('sendInd_9_off').disabled = false;
            document.getElementById('sendInd_8_off').disabled = false;
            document.getElementById('sendInd_7_off').disabled = false;
            document.getElementById('sendInd_6_off').disabled = false;
            document.getElementById('sendInd_5_off').disabled = false;
            document.getElementById('sendInd_4_off').disabled = false;
            document.getElementById('sendInd_3_off').disabled = false;
            document.getElementById('sendInd_2_off').disabled = false;
            document.getElementById('sendInd_1_off').disabled = false;
        }

				async function sendStartStreaming() {
						if (!device || !device.opened) {
								updateStatus('Device not connected');
								return;
						}

						try {
								// The full command as a Uint8Array [for Lap_Camera:  \h(8D 00 00 00) ]
								const command = new Uint8Array([
										0x04, 0x8d, 0x00, 0x00, 0x00, 0x00, 0x00, 
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
								]);
								// Send with report ID (change 0x01 if your device uses different ID)
								await device.sendReport(63, command);
								console.log("Command sent successfully");
						} catch (error) {
								updateStatus(`Send error: ${error.message}`);
								console.error('Command failed:', error);
						}
				}

				async function sendTBD() {
						if (!device || !device.opened) {
								updateStatus('Device not connected');
								return;
						}

						try {
								// The full command as a Uint8Array
								const command = new Uint8Array([
										0x04, 0x96, 0x00, 0x00, 0x00, 0x00, 0x00, 
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
								]);
								// Send with report ID (change 0x01 if your device uses different ID)
								await device.sendReport(63, command);
								console.log("Command sent successfully");
						} catch (error) {
								updateStatus(`Send error: ${error.message}`);
								console.error('Command failed:', error);
						}
				}

				async function sendInd_x(Ind_x, OnOff) {
            drawCircle();
						if (!device || !device.opened) {
								updateStatus('Device not connected');
								return;
						}

            //Yat command:  \h(03 03 00 00 01 08 01)
						try {
								// The full command as a Uint8Array
								const command = new Uint8Array([
                    //                            port  Pin
										0x07, 0x03, 0x03, 0x00, 0x00, 0x01, 0x01, 
                 // OnOff
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
								]);
                switch (Ind_x) {
                    case 1:
                        // PA0
                        command[5] = 1; // port PA0
                        command[6] = 1; // pin 
                        break;
                    case 2:
                        command[5] = 1; // port PA1
                        command[6] = 2; // pin 
                        break;
                    case 3:
                        command[5] = 1; // port PA2
                        command[6] = 4; // pin 
                        break;
                    case 4:
                        command[5] = 1; // port PA3
                        command[6] = 0x08; // pin 
                        break;
                    case 5:
                        command[5] = 1; // port PA4
                        command[6] = 0x10; // pin 
                        break;
                    case 6:
                        command[5] = 1; // port PA5
                        command[6] = 0x20; // pin 
                        break;
                    case 7:
                        command[5] = 1; // port PA6
                        command[6] = 0x40; // pin 
                        break;
                    case 8:
                        command[5] = 1; // port PA7
                        command[6] = 0x80; // pin 
                        break;
                    case 9:
                        command[5] = 2; // port PB0
                        command[6] = 0x01; // pin 
                        break;
                    // ... more cases
                    default:
                        // Code to execute if none of the cases match
                        alert("Bad input select");
                }
								// Send with report ID (change 0x01 if your device uses different ID)
                if ( OnOff == 1 ) {  // OnOff = on = 1
                    command[7] = 1;
                } else {    // OnOff = off = 0
                    command[7] = 0;
                }
                
								await device.sendReport(63, command);
								console.log("Command sendAmp successfully");

								await device.sendReport(63, command);
								console.log("Command sent successfully");
						} catch (error) {
								updateStatus(`Send error: ${error.message}`);
								console.error('Command failed:', error);
						}
				}

				async function sendGetVersion() {
						if (!device || !device.opened) {
								updateStatus('Device not connected');
								return;
						}

						try {
								// The full command as a Uint8Array  (06 00 00 01)
								const command = new Uint8Array([
										0x04, 0x06, 0x00, 0x00, 0x01, 0x00, 0x00, 
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
								]);
								// Send with report ID (change 0x01 if your device uses different ID)
								await device.sendReport(63, command);
								console.log("Command sendGetVersion successfully");
						} catch (error) {
								updateStatus(`Send error: ${error.message}`);
								console.error('Command failed:', error);
						}
				}

				async function sendResetMCU() {
						if (!device || !device.opened) {
								updateStatus('Device not connected');
								return;
						}

						try {
                // Yat command: \h(07 00 00 00)
								const command = new Uint8Array([
										0x04, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
								]);
								// Send with report ID (change 0x01 if your device uses different ID)
								await device.sendReport(63, command);
								console.log("Command sendGetVersion successfully");
						} catch (error) {
								updateStatus(`Send error: ${error.message}`);
								console.error('Command failed:', error);
						}
				}

				async function SaveCalibToFlash() {
						if (!device || !device.opened) {
								updateStatus('Device not connected');
								return;
						}

						try {
                // Yat command: \h(99 01 00 01 04)
								const command = new Uint8Array([
										0x05, 0x99, 0x01, 0x00, 0x01, 0x04, 0x00, 
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
								]);
								// Send with report ID (change 0x01 if your device uses different ID)
								await device.sendReport(63, command);
								console.log("Command SaveCalibToFlash successfully");
						} catch (error) {
								updateStatus(`Send error: ${error.message}`);
								console.error('Command failed:', error);
						}
				}

				async function sendResetBNO055() {
						if (!device || !device.opened) {
								updateStatus('Device not connected');
								return;
						}

						try {
                // Yat command: \h(07 00 00 00)
								const command = new Uint8Array([
										0x04, 0x8A, 0x00, 0x00, 0x00, 0x00, 0x00, 
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
								]);
								// Send with report ID (change 0x01 if your device uses different ID)
								await device.sendReport(63, command);
								console.log("Command sendGetVersion successfully");
						} catch (error) {
								updateStatus(`Send error: ${error.message}`);
								console.error('Command failed:', error);
						}
				}

				async function sendBslDFU() {
						if (!device || !device.opened) {
								updateStatus('Device not connected');
								return;
						}

						try {
                // Yat command: \h(AA 00 00 01)
								const command = new Uint8Array([
										0x04, 0xAA, 0x00, 0x00, 0x00, 0x00, 0x00, 
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
										0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
								]);
								// Send with report ID (change 0x01 if your device uses different ID)
								await device.sendReport(63, command);
								console.log("Command sendGetVersion successfully");
						} catch (error) {
								updateStatus(`Send error: ${error.message}`);
								console.error('Command failed:', error);
						}
				}

        function handleInputReport(event) {
            const { data, reportId } = event;
            const timestamp = new Date().toLocaleTimeString();
            
            updateDebug(`Report ${reportId} (${data.byteLength} bytes) @ ${timestamp}`);

            if (data.byteLength !== 63) {
                updateDebug(`Unexpected payload length: ${data.byteLength} bytes`);
                return;
            }

//    Lap4_out_buffer[34-2] = yaw16 & 0xFF;
//    Lap4_out_buffer[35-2] = yaw16>>8;
//    Lap4_out_buffer[36-2] = roll16 & 0xFF;
//    Lap4_out_buffer[37-2] = roll16>>8;
//    Lap4_out_buffer[38-2] = pitch16 & 0xFF;
//    Lap4_out_buffer[39-2] = pitch16>>8;

            try {
                // mapping : index 0 in Lap4_out_buffer[0] is index 1 JavaScript data.getUint8(1) 
								// yaw_pitch_roll
								yawHi = data.getUint8(34); 
								yawLo = data.getUint8(33); 
								pitchHi = data.getUint8(38); 
								pitchLo = data.getUint8(37); 
								rollHi = data.getUint8(36); 
								rollLo = data.getUint8(35); 
								let yaw = (yawHi*256 + yawLo);
								let pitch = (pitchHi*256 + pitchLo);
								let roll = (rollHi*256 + rollLo);
								if(yaw > 2**15) 
									yaw -= 2**16;
								if(pitch > 2**15) 
									pitch -= 2**16;
								if(roll > 2**15) 
									roll -= 2**16;
                yaw = Math.floor(yaw/16)
                pitch = Math.floor(pitch/16)
                roll = Math.floor(roll/16)
                document.getElementById('output3').textContent = (`yaw: ${yaw} `);
                document.getElementById('output4').textContent = (`pitch: ${pitch} `);
                document.getElementById('output5').textContent = (`roll: ${roll} `);

                let DigitalHi = data.getUint8(11); 
                let DigitalLo = data.getUint8(12); 

                // Convert to 8-bit binary strings
                let DigitalHiBin = DigitalHi.toString(2).padStart(8, '0');
                let DigitalLoBin = DigitalLo.toString(2).padStart(8, '0');

                document.getElementById('output6').textContent =  `Digital Inputs BitArray: ${DigitalHiBin} ${DigitalLoBin}`;
                
                DigitalHi = data.getUint8(13); 
                DigitalLo = data.getUint8(14); 
                
                // on change in digital input 
                if (prevDigitalHi != DigitalHi || prevDigitalLo != DigitalLo)  // Fixed = to !=
                {
                  // erase the previous Image
                  redrawImageOnly();

                  for (let i = 0; i < 9; i++) {
                    let isOn;

                    if (i < 8) {
                      isOn = (DigitalLo >> i) & 1;   // LEDs 1–8 from DigitalLo
                    } else {
                      isOn = (DigitalHi >> 0) & 1;   // LED9 from DigitalHi
                    }

                    if (isOn) {
                      setLedIndication(i + 1);
                    }
                  }
                }
                // Update previous values
                prevDigitalHi = DigitalHi ; 
                prevDigitalLo = DigitalLo ; 
                

                // Convert to 8-bit binary strings
                DigitalHiBin = DigitalHi.toString(2).padStart(8, '0');
                DigitalLoBin = DigitalLo.toString(2).padStart(8, '0');

                document.getElementById('output7').textContent =  `Digital Outputs_1 BitArray: ${DigitalHiBin} ${DigitalLoBin}`;
                
                DigitalHi = data.getUint8(15); 
                DigitalLo = data.getUint8(16); 

                // Convert to 8-bit binary strings
                DigitalHiBin = DigitalHi.toString(2).padStart(8, '0');
                DigitalLoBin = DigitalLo.toString(2).padStart(8, '0');

                document.getElementById('output8').textContent =  `Digital Outputs_2 BitArray: ${DigitalHiBin} ${DigitalLoBin}`;
                
                // get the analog values 
								Ana_1_Hi = data.getUint8(2); 
								Ana_1_Lo = data.getUint8(1); 
								Ana_2_Hi = data.getUint8(4); 
								Ana_2_Lo = data.getUint8(3); 
								Ana_3_Hi = data.getUint8(6); 
								Ana_3_Lo = data.getUint8(5); 
								Ana_4_Hi = data.getUint8(8); 
								Ana_4_Lo = data.getUint8(7); 
								
                // Ana_5_Hi = data.getUint8(12); 
								// Ana_5_Lo = data.getUint8(11); 
								// Ana_6_Hi = data.getUint8(14); 
								// Ana_6_Lo = data.getUint8(13); 
								// Ana_7_Hi = data.getUint8(16); 
								// Ana_7_Lo = data.getUint8(15); 

								let Ana_1_w = (Ana_1_Hi*256 + Ana_1_Lo);
								let Ana_2_w = (Ana_2_Hi*256 + Ana_2_Lo);
								let Ana_3_w = (Ana_3_Hi*256 + Ana_3_Lo);
								let Ana_4_w = (Ana_4_Hi*256 + Ana_4_Lo);
								//let Ana_5_w = (Ana_5_Hi*256 + Ana_5_Lo);
								//let Ana_6_w = (Ana_6_Hi*256 + Ana_6_Lo);
								//let Ana_7_w = (Ana_7_Hi*256 + Ana_7_Lo);

                //document.getElementById('output8').textContent =  `Analog Value:\n [Arm_R=${Ana_1_w}]  [Arm_L=${Ana_2_w}]  \n[Leg_R=${Ana_3_w}]  [Leg_L=${Ana_4_w}]`;
                document.getElementById('output9').innerHTML =  `Analog Value: <br>[Grasper_R=${Ana_1_w}]  [Grasper_L=${Ana_2_w}]  <br>[Grasper_R_Rot=${Ana_3_w}]  [Grasper_L_Rot=${Ana_4_w}]`;
                //document.getElementById('output9').innerHTML =  `Analog Value Jaw: <br>[JAW_Rot=${Ana_5_w}]  [JAW_Opti_R=${Ana_6_w}]  [JAW_Opti_L=${Ana_7_w}]`;
     
                // read the Current BNO055 system calibration status
                // Lap4_out_buffer[39] = calib_status; // bno055 calibration status. --> here index 40 
                calib_status = data.getUint8(40); 
                let calib_statusBin = calib_status.toString(2).padStart(8, '0');
                // document.getElementById('output10').innerHTML =  `calib_status: [${calib_statusBin}] ]`;
                
                // Split the 8-bit string into four 2-bit groups
                let sysBits = calib_statusBin.substring(0, 2);
                let gyrBits = calib_statusBin.substring(2, 4);
                let accBits = calib_statusBin.substring(4, 6);
                let magBits = calib_statusBin.substring(6, 8);
                // Create the display string with fixed-width font (using monospace) and alignment
                let outputHTML = `<pre style="font-family: monospace; margin: 0px; padding: 0px;">calib_status:   SYS  GYR  ACC  MAG<br>                ${sysBits}   ${gyrBits}   ${accBits}   ${magBits}</pre>`;
                document.getElementById('output10').innerHTML = outputHTML;                

                // check echo of FW version:
                // YAT: (01:21:01.322) (>>) 06 06 00 01 07 00 02 06 07 25 (10)
                //if( flowLo == 6 ) // && flowHi == 6)
                if( data.getUint8(1) == 6 && data.getUint8(2) == 6)
                {
                  a1 = data.getUint8(5); 
                  a2 = data.getUint8(6); 
                  a3 = data.getUint8(7); 
                  b1 = data.getUint8(8); 
                  b2 = data.getUint8(9); 
                  b3 = data.getUint8(10); 
                  console.log("check echo of FW version");
                  console.log(`FW version ${a1}.${a2}.${a3} date: ${b1.toString(16)}.${b2.toString(16)}.${b3.toString(16)}`);
                }
								
            } catch (error) {
                updateDebug(`Error parsing data: ${error.message}`);
            }
        }

        function updateStatus(text) {
            document.getElementById('status').textContent = `Status: ${text}`;
        }

        function updateDebug(text) {
            document.getElementById('debug').textContent = text;
        }
        function pinkButtonAction() {
        // yat reset MCU command \h(07 00 00 00)
            alert("Pink button clicked! replace this with the desired action");
        }
        // history:
        // 2026_02_21: 
        // - adding 9 x 2 buttons sendInd_1 .. 9 for setting and resetting CamPosInd_1 .. 9 output indications.
        // 2026_02_23 
        // - adding image to the app : img class="responsive-img"
        // 2026_02_24
        // - adding leds indications on the img by using setLedIndication() function

    </script>
</body>
</html>
